// Новая версия parseFoodRu
function parseFoodRu(html: string, sourceUrl: string): ImportedRecipe | null {
  try {
    // Food.ru использует Next.js, данные в __NEXT_DATA__
    const match = html.match(/<script id="__NEXT_DATA__"[^>]*>(.*?)<\/script>/s);
    if (!match) {
      console.log("⚠️ __NEXT_DATA__ не найден на food.ru");
      return null;
    }

    const nextData = JSON.parse(match[1]);
    const state = nextData?.props?.pageProps?.__EFFECTOR_NEXTJS_INITIAL_STATE__;

    if (!state) {
      console.log("⚠️ Effector state не найден");
      return null;
    }

    // Ищем данные рецепта - ищем объект с полями preparation, cooking
    let recipeData: any = null;

    for (const key in state) {
      const value = state[key];
      if (value && typeof value === 'object') {
        // Food.ru хранит рецепты со структурой: preparation, cooking, impression
        if (value.preparation && value.cooking && value.title) {
          recipeData = value;
          console.log("✅ Найдены данные рецепта food.ru в ключе:", key);
          break;
        }
      }
    }

    if (!recipeData) {
      console.log("⚠️ Данные рецепта не найдены в state");
      return null;
    }

    const title = recipeData.title || "Рецепт";

    // Извлекаем описание из subtitle (сложная структура)
    let description = recipeData.snippet || "";
    if (recipeData.subtitle?.children?.[0]?.children?.[0]?.content) {
      description = recipeData.subtitle.children[0].children[0].content;
    }

    // Извлекаем картинку
    const imageUrl = recipeData.cover?.image_path
      ? `https://cdn.food.ru/unsigned/fit/640/480/ce/0/czM6Ly9tZWRpYS8ke recipeData.cover.image_path}`
      : undefined;

    // Извлекаем ингредиенты из HTML (в JSON их нет)
    const $ = cheerio.load(html);
    const ingredients: Array<{ name: string; amount: string; unit: string }> = [];

    $('[data-test="ingredient-item"]').each((_, el) => {
      const text = $(el).text().trim();
      if (text && text.length > 2 && text.length < 200) {
        // Фильтруем мусор
        if (!text.includes('Пищевая ценность') &&
            !text.includes('Уровни') &&
            !text.includes('Калорийность') &&
            !text.includes('минут') &&
            !text.match(/^[\d\s—-]+$/)) {
          const parsed = parseIngredientText(text);
          if (parsed.name && parsed.name.length > 2) {
            ingredients.push(parsed);
          }
        }
      }
    });

    // Извлекаем шаги из JSON (preparation + cooking + impression)
    const steps: Array<{ text: string }> = [];

    const allSteps = [
      ...(recipeData.preparation || []),
      ...(recipeData.cooking || []),
      ...(recipeData.impression || [])
    ];

    allSteps.forEach((step: any) => {
      let text = "";

      // Извлекаем текст из сложной структуры description
      if (step.description?.children?.[0]?.children?.[0]?.content) {
        text = step.description.children[0].children[0].content;
      } else if (typeof step.description === 'string') {
        text = step.description;
      }

      if (text && text.trim() && text.length > 10) {
        steps.push({ text: text.trim() });
      }
    });

    return {
      title,
      description,
      imageUrl,
      prepTime: parseInt(recipeData.active_cooking_time) || undefined,
      cookTime: parseInt(recipeData.total_cooking_time) || undefined,
      servings: parseInt(recipeData.measure_count) || undefined,
      cuisine: recipeData.cuisines?.[0]?.name || undefined,
      tags: Array.isArray(recipeData.tags) ? recipeData.tags.map((t: any) => t.title || t.name || t).slice(0, 5) : [],
      ingredients,
      steps,
      sourceUrl,
      sourceDomain: "food.ru",
      confidence: ingredients.length > 0 && steps.length > 0 ? "high" : "medium",
    };
  } catch (err) {
    console.error("❌ Ошибка парсинга food.ru:", err);
    return null;
  }
}
